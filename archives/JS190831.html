<!-- build time:Wed Sep 04 2019 14:04:24 GMT+0800 (GMT+08:00) --><!DOCTYPE HTML><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="Cache-Control" content="no-transform"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="apple-mobile-web-app-capable" content="Onions说前端 - 从未如此简单有趣"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="browsermode" content="application"><meta name="screen-orientation" content="portrait"><link rel="dns-prefetch" href="http://algate.github.io"><meta name="keywords" content="微信公众号"><meta name="description" content="说明: 微信公众号文档，以及python，好友后续的内容涉及的相关知识，都在python2.7版本下进行的测试验证python3.0+版本出现各种问题，so，以下内容都在python2.7的环境..."><meta name="robots" content="all"><meta name="google" content="all"><meta name="googlebot" content="all"><meta name="verify" content="all"><title>微信公众号Django-内网穿透-服务器配置-python环境-token验证.md | Onions说前端 - 从未如此简单有趣</title><link rel="alternate" href="/atom.xml" title="Onions说前端 - 从未如此简单有趣" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7"><link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0"><link rel="stylesheet" href="/css/style.css?rev=@@hash"><div><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1276282118'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s96.cnzz.com/z_stat.php%3Fid%3D1276282118%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script></div><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?617bf75bfd954382202927d87bf48f13";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]--><!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]--><body><header class="main-header"><div class="main-header-box"><div class="canvas-box"><canvas id="canvas"></canvas></div><a class="header-avatar" href="/" title="onions"><img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block"></a><div class="branding"><h2>不要跟我谈理想，我的理想是不工作</h2></div></div></header><nav class="main-navigation"><div class="container"><div class="row"><div class="col-sm-12"><div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav"><span class="sr-only"></span> <i class="fa fa-bars"></i> </span><a class="navbar-brand" href="http://algate.github.io">Onions说前端 - 从未如此简单有趣</a></div><div class="collapse navbar-collapse" id="main-menu"><ul class="menu"><li role="presentation" class="text-center"><a href="/"><i class="fa fa-home"></i>首页</a></li><li role="presentation" class="text-center"><a href="/categories/前端/"><i class="fa fa-chrome"></i>前端</a></li><li role="presentation" class="text-center"><a href="/categories/工具/"><i class="fa fa-wrench"></i>工具</a></li><li role="presentation" class="text-center"><a href="/archives/"><i class="fa fa-clock-o"></i>时间轴</a></li><li role="presentation" class="text-center"><a href="/categories/要闻/"><i class="fa fa-google-wallet"></i>要闻</a></li><li role="presentation" class="text-center"><a href="/categories/日记/"><i class="fa fa-book"></i>日记</a></li><li role="presentation" class="text-center"><a href="/404.html"><i class="fa fa-bug"></i>404</a></li></ul></div></div></div></div></nav><section class="content-wrap"><div class="container"><div class="row"><main class="col-md-8 main-content m-post"><p id="process"></p><article class="post"><div class="post-head"><h1 id="微信公众号Django-内网穿透-服务器配置-python环境-token验证.md">微信公众号Django-内网穿透-服务器配置-python环境-token验证.md</h1><div class="post-meta"><span class="categories-meta fa-wrap"><i class="fa fa-folder-open-o"></i> <a class="category-link" href="/categories/前端/">前端</a> </span><span class="fa-wrap"><i class="fa fa-tags"></i> <span class="tags-meta"><a class="tag-link" href="/tags/微信公众号/">微信公众号</a> </span></span><span class="fa-wrap"><i class="fa fa-clock-o"></i> <span class="date-meta">2019/08/31</span></span></div></div><div class="post-body post-content"><blockquote><blockquote><blockquote><p>说明: 微信公众号文档，以及python，好友后续的内容涉及的相关知识，都在python2.7版本下进行的测试验证<br>python3.0+版本出现各种问题，so，以下内容都在python2.7的环境下有效,先安装python2.7</p></blockquote></blockquote></blockquote><h2 id="1-微信公众号开发者文档服务器配置"><a href="#1-微信公众号开发者文档服务器配置" class="headerlink" title="1.微信公众号开发者文档服务器配置"></a>1.微信公众号开发者文档服务器配置</h2><h3 id="1-1-搭建服务-Python-Web服务"><a href="#1-1-搭建服务-Python-Web服务" class="headerlink" title="1-1.搭建服务(Python Web服务)"></a>1-1.搭建服务(Python Web服务)</h3><p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1472017492_58YV5" target="_blank" rel="noopener">开发者文档</a><br>这里就用Django搭建服务了，方便省事(不用自己写代码了)</p><h2 id="2-搭建Django-Python-Web-框架"><a href="#2-搭建Django-Python-Web-框架" class="headerlink" title="2.搭建Django(Python Web 框架)"></a>2.搭建Django(Python Web 框架)</h2><h3 id="2-1-安装Django"><a href="#2-1-安装Django" class="headerlink" title="2.1 安装Django"></a>2.1 安装Django</h3><p><a href="https://docs.djangoproject.com/zh-hans/2.1/topics/" target="_blank" rel="noopener">Django官方</a><br>直接看 如何在Windows上安装Django？</p><p>[1]<code>pip install Django</code>(推荐 pip为python的安装工具也可以使用easy_install django来进行安装)</p><h3 id="2-2-创建your-first-Django-app"><a href="#2-2-创建your-first-Django-app" class="headerlink" title="2.2 创建your first Django app"></a>2.2 创建your first Django app</h3><p><a href="https://docs.djangoproject.com/en/2.2/intro/tutorial01/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/2.2/intro/tutorial01/</a></p><p><code>django-admin startproject mysite</code> mysite为你要创建的web站文件夹 我的为 DjangoWechat<br>创建完之后，文件夹下会有一个文件夹，cd之后，里边还有个一相同的文件夹名</p><pre><code>mysite/
manage.py
mysite/
    __init__.py
    settings.py
    urls.py
    wsgi.py
</code></pre><h3 id="2-3-启动服务"><a href="#2-3-启动服务" class="headerlink" title="2.3 启动服务"></a>2.3 启动服务</h3><p><code>py manage.py runserver 8080</code><br>打开浏览器就可以看到成功的默认页面</p><h3 id="2-4-部署自己的app项目"><a href="#2-4-部署自己的app项目" class="headerlink" title="2.4 部署自己的app项目"></a>2.4 部署自己的app项目</h3><p>首先创建一个存放你项目的app<br><code>python manage.py startapp polls</code> 我的是wechat</p><pre><code>polls/
__init__.py
admin.py
apps.py
migrations/
    __init__.py
models.py
tests.py
views.py
</code></pre><blockquote><blockquote><p>Django默认是吧页面放到templates下的，资源是放在static下的<br>一般打包的项目index.html加一个static文件夹，<br>so 复制你的项目到polls下，把index.html放到templates下即可，不需要修改你项目里的路径</p></blockquote></blockquote><h3 id="2-5-访问服务下的index-html"><a href="#2-5-访问服务下的index-html" class="headerlink" title="2.5 访问服务下的index.html"></a>2.5 访问服务下的index.html</h3><p>2.5.1 修改Djangon项目下urls.py</p><pre><code># 导入app
from polls(wechat) import views

# add
url(r&apos;^$&apos;, views.home, name=&apos;home&apos;),
</code></pre><p>2.5.2 修改polls(wechat)下views.py</p><pre><code># from django.shortcuts import render
from django.shortcuts import render, render_to_response, HttpResponse

def home(request):
return render_to_response(&apos;index.html&apos;)
</code></pre><p>现在应该可以看到index.html效果展示了</p><h2 id="3-微信服务器配置token验证"><a href="#3-微信服务器配置token验证" class="headerlink" title="3.微信服务器配置token验证"></a>3.微信服务器配置token验证</h2><h3 id="3-1-公众号登录-基础配置-服务器配置"><a href="#3-1-公众号登录-基础配置-服务器配置" class="headerlink" title="3.1 公众号登录 - 基础配置 - 服务器配置"></a>3.1 公众号登录 - 基础配置 - 服务器配置</h3><p>服务器地址(URL) ： http://此处可以通过内网穿透来实现自己的域名/weixin/(weixin这个自己定义，需要和Django下的定义的接口一致就行)<br>令牌(Token)：设置自己的我是起的项目名CloudUI<br>消息加解密密钥(EncodingAESKey)：点击按钮自动生成</p><h3 id="3-2-点击提交，你会发现报错"><a href="#3-2-点击提交，你会发现报错" class="headerlink" title="3.2 点击提交，你会发现报错"></a>3.2 点击提交，你会发现报错</h3><p>token验证失败 - 只是最多的提示，就是微信发送请求，没哟得到正确的结果<br>请求超时，说明服务没起</p><h2 id="4-Django服务添加验证接口"><a href="#4-Django服务添加验证接口" class="headerlink" title="4.Django服务添加验证接口"></a>4.Django服务添加验证接口</h2><h3 id="4-1-修改Django项目下的urls-py"><a href="#4-1-修改Django项目下的urls-py" class="headerlink" title="4.1 修改Django项目下的urls.py"></a>4.1 修改Django项目下的urls.py</h3><p>4.1.1修改Djangon项目下urls.py</p><pre><code># 添加接口(views为之前修改首页导入的app的入口模块，wechat为定义的app下的访问的模块方法)
url(r&apos;weixin/.*&apos;, views.wechat),
</code></pre><p>4.1.2 修改polls(wechat)下views.py</p><pre><code># add wechat-token
from django.views.decorators.csrf import csrf_exempt  # 解除csrf验证
from wechat_sdk import WechatConf
from wechat_sdk import WechatBasic

## add wechat-token
conf = WechatConf(  # 实例化配置信息对象
    token=&apos;&apos;,  # 服务器配置-Token
    appid=&apos;&apos;,  # 公众号开发信息-开发者ID
    appsecret=&apos;&apos;,  # 公众号开发信息-开发者密码
    encrypt_mode=&apos;normal&apos;,  # 服务器配置-明文模式
    encoding_aes_key=&apos;&apos;  # 服务器配置-EncodingAESKey
)
@csrf_exempt  # 去除csrf验证
def wechat(request):
    signature = request.GET.get(&apos;signature&apos;)  # 获取请求信息
    timestamp = request.GET.get(&apos;timestamp&apos;)
    nonce = request.GET.get(&apos;nonce&apos;)
    wechat_instance = WechatBasic(conf=conf)  # 实例化微信基类对象
    if not wechat_instance.check_signature(signature=signature, timestamp=timestamp, nonce=nonce):  # 检查验证请求的签名
        return HttpResponseBadRequest(&apos;Verify Failed&apos;)
    else:
        if request.method == &apos;GET&apos;:
            return HttpResponse(request.GET.get(&apos;echostr&apos;, None))  # 返回请求中的回复信息
</code></pre><h3 id="4-2-安装wechat-sdk"><a href="#4-2-安装wechat-sdk" class="headerlink" title="4.2 安装wechat-sdk"></a>4.2 安装wechat-sdk</h3><p><code>pip install wechat-sdk</code></p><p>此处服务如果报错 |_</p><h3 id="4-3-Unable-to-find-vcvarsall-bat"><a href="#4-3-Unable-to-find-vcvarsall-bat" class="headerlink" title="4.3 Unable to find vcvarsall.bat"></a>4.3 Unable to find vcvarsall.bat</h3><p>(有可能是找不到模块导致的)<br>(安装python的时候可能报错 - 此处如果报错跟这个可能关系不大 - 往上翻)报错往上翻，不是文档往上翻<br><a href="https://www.cnblogs.com/yyds/p/7065637.html" target="_blank" rel="noopener">Unable to find vcvarsall.bat</a></p><h3 id="4-4-安装Crypto"><a href="#4-4-安装Crypto" class="headerlink" title="4.4 安装Crypto"></a>4.4 安装Crypto</h3><p>官方验证有个Python实例(用于验证的)：</p><pre><code>目录: E:\JavascriptCode\webPy\微信公众号\SampleCode\Python
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        2017/7/27     20:40            795 ierror.py
-a----        2017/7/27     20:40           2372 Sample.py
-a----        2017/7/27     20:40           9400 WXBizMsgCrypt.py
-a----        2017/7/27     20:40              0 __init__.py
</code></pre><p>如果用到WXBizMsgCrypt.py，在windows会报错<br><code>from Crypto.Cipher import AES</code> ImportError: No module named ‘Crypto’</p><p>可以直接<code>pip install Crypto</code> 如果成功，直接看第五步，如果不成功就接着看。</p><p>里边有这么一段：<br>“””<br>关于Crypto.Cipher模块，ImportError: No module named ‘Crypto’解决方案<br>请到官方网站 <a href="https://www.dlitz.net/software/pycrypto/" target="_blank" rel="noopener">https://www.dlitz.net/software/pycrypto/</a> 下载pycrypto。<br>下载后，按照README中的“Installation”小节的提示进行pycrypto安装。<br>“””</p><p>下载pycrypto-2.6.1.tar.gz文件<br>接4.4</p><h3 id="4-5-解压pycrypto下找到readme文件的Installation"><a href="#4-5-解压pycrypto下找到readme文件的Installation" class="headerlink" title="4.5 解压pycrypto下找到readme文件的Installation"></a>4.5 解压pycrypto下找到readme文件的Installation</h3><p>执行 <code>python setup.py install</code></p><p>会发现报错<code>Unable to find vcvarsall.bat</code></p><p>(此处关系不大，否则python安装会提示)先验证vb，vc是否安装？<a href="https://www.cnblogs.com/yyds/p/7065637.html" target="_blank" rel="noopener">Unable to find vcvarsall.bat</a></p><p>如果还是报错</p><p>Python安装目录\Lib\site-packages下是否有Crypto<br>如果有，保证首字母大写<br>如果没有，copy一份放进去。重新执行 py setup.py install（pip install Crypto）即可，只要最后出现successing的字样就表示你成功了！</p><h2 id="5-内网穿透"><a href="#5-内网穿透" class="headerlink" title="5.内网穿透"></a>5.内网穿透</h2><h3 id="5-1-网上随便找一个就ok，只要能外网访问到项目就ok"><a href="#5-1-网上随便找一个就ok，只要能外网访问到项目就ok" class="headerlink" title="5.1 网上随便找一个就ok，只要能外网访问到项目就ok"></a>5.1 网上随便找一个就ok，只要能外网访问到项目就ok</h3><p>Django 与 设置的外网访问的 端口号要保持一致</p><p>127.0.0.1带上微信请求的接口自己本地先测试下。是否ok，欧克的话就可以公众号验证token了。<br>此处需要把127.0.0.1 /内网穿透的域名 配置到Django环境下settings.py的<code>ALLOWED_HOSTS = []</code>里</p><p>如果不成功那就看看报错出在哪里。慢慢解决</p><p>此处的域名访问填写到微信公众号的服务器配置里<br>分别填写token，密钥<br>然后提交，就会发现token验证成功了，如果报错，请上翻查找原因</p></div><div class="reward" ontouchstart><div class="reward-wrap">赏<div class="reward-box"><span class="reward-type"><img class="alipay" src="/img/alipayimg.png"><b>支付宝打赏</b> </span><span class="reward-type"><img class="wechat" src="/img/weipayimg.png"><b>微信打赏</b></span></div></div><p class="reward-tip">赞赏是不耍流氓的鼓励</p></div><div class="post-footer"><div>转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href target="_blank">Onions</a></div><div></div></div></article><div class="article-nav prev-next-wrap clearfix"><a href="/archives/JS190829.html" class="next-post btn btn-default" title="内网穿透工具"><span class="hidden-lg">下一篇</span> <span class="hidden-xs">内网穿透工具</span><i class="fa fa-angle-right fa-fw"></i></a></div><div id="comments"><div id="vcomments" class="valine"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="/assets/valine.min.js"></script><script>new Valine({av:AV,el:"#vcomments",appId:"XCBkrMT2cT5gHnAV3uKwy2Eo-gzGzoHsz",appKey:"bX6iJOMctdSEGOXysJloaoGN",placeholder:"不要和我谈理想，我的理想是不上班！",notify:!1,verify:!1,avatar:"onions",meta:"nick,mail".split(","),pageSize:"10",path:window.location.pathname,lang:"zh-CN".toLowerCase()})</script></div></main><aside id="article-toc" role="navigation" class="col-md-4"><div class="widget"><h3 class="title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-微信公众号开发者文档服务器配置"><span class="toc-text">1.微信公众号开发者文档服务器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-搭建服务-Python-Web服务"><span class="toc-text">1-1.搭建服务(Python Web服务)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-搭建Django-Python-Web-框架"><span class="toc-text">2.搭建Django(Python Web 框架)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-安装Django"><span class="toc-text">2.1 安装Django</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-创建your-first-Django-app"><span class="toc-text">2.2 创建your first Django app</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-启动服务"><span class="toc-text">2.3 启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-部署自己的app项目"><span class="toc-text">2.4 部署自己的app项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-访问服务下的index-html"><span class="toc-text">2.5 访问服务下的index.html</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-微信服务器配置token验证"><span class="toc-text">3.微信服务器配置token验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-公众号登录-基础配置-服务器配置"><span class="toc-text">3.1 公众号登录 - 基础配置 - 服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-点击提交，你会发现报错"><span class="toc-text">3.2 点击提交，你会发现报错</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Django服务添加验证接口"><span class="toc-text">4.Django服务添加验证接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-修改Django项目下的urls-py"><span class="toc-text">4.1 修改Django项目下的urls.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-安装wechat-sdk"><span class="toc-text">4.2 安装wechat-sdk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Unable-to-find-vcvarsall-bat"><span class="toc-text">4.3 Unable to find vcvarsall.bat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-安装Crypto"><span class="toc-text">4.4 安装Crypto</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-解压pycrypto下找到readme文件的Installation"><span class="toc-text">4.5 解压pycrypto下找到readme文件的Installation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-内网穿透"><span class="toc-text">5.内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-网上随便找一个就ok，只要能外网访问到项目就ok"><span class="toc-text">5.1 网上随便找一个就ok，只要能外网访问到项目就ok</span></a></li></ol></li></ol></div></aside></div></div></section><footer class="main-footer"><div class="container"><div class="row"></div></div></footer><a id="back-to-top" class="icon-btn hide"><i class="fa fa-chevron-up"></i></a><div class="copyright"><div class="container"><div class="row"><div class="col-sm-12"><div class="busuanzi">访问量: <strong id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i> </strong>&nbsp; | &nbsp; 访客数: <strong id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></strong></div></div><div class="col-sm-12"><span>版权所有 onions洋葱信息技术Copyright &copy; 2016-2019 </span>| <span>Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a> </span>| <span>Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a></span></div></div></div></div><script src="/assets/tagcanvas.min.js?rev=2.9"></script><script>var tagOption={textColour:"#444",outlineMethod:"block",outlineColour:"#FFDAB9",interval:30,textHeight:13,outlineRadius:3,freezeActive:!0,frontSelect:!0,initial:[.1,-.1],depth:.5,decel:.95,maxSpeed:.03,reverse:!0,fadeIn:500,wheelZoom:!0};TagCanvas.Start("tag-cloud-3d","",tagOption)</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/assets/vector.js?rev=@@hash"></script><script src="/assets/reject.js?rev=@@hash"></script><script src="/js/app.js?rev=@@hash"></script></body><!-- rebuild by neat -->